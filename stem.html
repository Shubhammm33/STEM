<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEM Learning App Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom style for the glowing bulb in the lab */
        .bulb.on {
            filter: drop-shadow(0 0 1rem yellow);
        }
        /* Simple animation for quiz feedback */
        @keyframes feedback-pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .feedback-animation {
            animation: feedback-pop 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans antialiased">

    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg min-h-screen">

        <div id="login-page" class="p-6">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600" data-key="app_title">Game & Learn</h1>
                <p class="text-slate-500" data-key="app_subtitle">Your Journey into Science & Tech</p>
                <div class="mt-4 flex justify-center space-x-2">
                    <button onclick="setLanguage('en')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="en">English</button>
                    <button onclick="setLanguage('hi')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="hi">हिंदी</button>
                    <button onclick="setLanguage('mr')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="mr">मराठी</button>
                </div>
            </header>

            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-3 text-slate-700" data-key="student_login_title">Student Login</h2>
                <form id="student-login-form" class="space-y-4">
                    <input type="text" id="school-code" class="w-full p-3 border rounded-md" data-key-placeholder="placeholder_school_code" required>
                    <input type="text" id="student-id" class="w-full p-3 border rounded-md" data-key-placeholder="placeholder_student_id" required>
                    <select id="student-standard" class="w-full p-3 border rounded-md bg-white">
                        <option value="6" data-key="standard_6">Standard 6</option>
                        <option value="7" data-key="standard_7">Standard 7</option>
                        <option value="8" data-key="standard_8">Standard 8</option>
                        <option value="9" data-key="standard_9">Standard 9</option>
                        <option value="10" data-key="standard_10">Standard 10</option>
                        <option value="11" data-key="standard_11">Standard 11</option>
                        <option value="12" data-key="standard_12">Standard 12</option>
                    </select>
                    <input type="password" id="student-password" class="w-full p-3 border rounded-md" data-key-placeholder="placeholder_password" required>
                    <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-md font-bold hover:bg-blue-600" data-key="login_button">Login</button>
                </form>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-3 text-slate-700" data-key="teacher_login_title">Teacher Login</h2>
                <form id="teacher-login-form" class="space-y-4">
                    <input type="email" id="teacher-email" class="w-full p-3 border rounded-md" data-key-placeholder="placeholder_email" required>
                    <input type="password" id="teacher-password" class="w-full p-3 border rounded-md" data-key-placeholder="placeholder_password" required>
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-md font-bold hover:bg-green-600" data-key="login_button">Login</button>
                </form>
            </div>
            <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
        </div>

        <div id="student-home-page" class="p-6 hidden">
            <header class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800" data-key="welcome">Welcome, Student!</h1>
                    <p class="text-slate-500" data-key="home_subtitle">Choose your adventure</p>
                </div>
                <button onclick="logout()" class="text-sm text-red-500 font-semibold flex-shrink-0" data-key="logout_button">Logout</button>
            </header>

            <div class="mb-6 flex justify-center space-x-2">
                <button onclick="setLanguage('en')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="en">English</button>
                <button onclick="setLanguage('hi')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="hi">हिंदी</button>
                <button onclick="setLanguage('mr')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="mr">मराठी</button>
            </div>
            
            <div class="space-y-4">
                <div onclick="showPage('stem-village-page')" class="bg-blue-500 text-white p-6 rounded-xl shadow-lg cursor-pointer hover:bg-blue-600 transition">
                    <h2 class="text-xl font-bold" data-key="mode1_title">STEM Village Simulator</h2>
                    <p class="mt-1 text-blue-100" data-key="mode1_desc">Build a village by mastering STEM concepts.</p>
                </div>
                <div onclick="showPage('knowledge-battle-page')" class="bg-orange-500 text-white p-6 rounded-xl shadow-lg cursor-pointer hover:bg-orange-600 transition">
                    <h2 class="text-xl font-bold" data-key="mode2_title">Knowledge Battle (ज्ञान युद्ध)</h2>
                    <p class="mt-1 text-orange-100" data-key="mode2_desc">Challenge an opponent in a fast-paced quiz.</p>
                </div>
                <div onclick="showPage('build-lab-page')" class="bg-purple-500 text-white p-6 rounded-xl shadow-lg cursor-pointer hover:bg-purple-600 transition">
                    <h2 class="text-xl font-bold" data-key="mode3_title">Build Your Own Lab (आपली प्रयोगशाळा)</h2>
                    <p class="mt-1 text-purple-100" data-key="mode3_desc">Conduct virtual experiments hands-on.</p>
                </div>
            </div>
        </div>

        <div id="stem-village-page" class="p-6 hidden">
            <button onclick="showPage('student-home-page')" class="mb-4 text-blue-600 font-semibold" data-key="back_button">&larr; Back to Home</button>
            <h1 class="text-2xl font-bold text-center mb-4" data-key="mode1_title">STEM Village</h1>
            
            <div class="bg-green-100 p-4 rounded-lg">
                <svg id="village-map" viewBox="0 0 200 120" class="w-full h-auto">
                    <rect width="200" height="120" fill="#a7f3d0" /> <g id="physics-lab" class="opacity-30 cursor-pointer" onclick="startQuiz('physics')">
                        <rect x="20" y="60" width="40" height="30" fill="#d1d5db" />
                        <polygon points="18,60 62,60 40,40" fill="#9ca3af" />
                        <text x="40" y="80" font-size="6" text-anchor="middle" fill="#374151" data-key="physics_lab">Physics Lab</text>
                    </g>
                    <g id="biology-farm" class="opacity-30 cursor-pointer" onclick="startQuiz('biology')">
                        <rect x="80" y="70" width="40" height="20" fill="#fca5a5" />
                        <rect x="85" y="60" width="30" height="10" fill="#ef4444" />
                        <text x="100" y="83" font-size="6" text-anchor="middle" fill="#374151" data-key="biology_farm">Biology Farm</text>
                    </g>
                    <g id="chemistry-workshop" class="opacity-30 cursor-pointer" onclick="startQuiz('chemistry')">
                        <rect x="140" y="50" width="40" height="40" fill="#a5b4fc" />
                        <circle cx="160" cy="70" r="8" fill="#6366f1" />
                        <text x="160" y="80" font-size="5" text-anchor="middle" fill="#374151" data-key="chemistry_workshop">Chemistry Shop</text>
                    </g>
                </svg>
            </div>
            <p class="text-center text-slate-500 mt-2" data-key="village_instructions">Click a grayed-out building to start a quiz and unlock it!</p>
            
            <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
                <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
                    <h2 id="quiz-title" class="text-xl font-bold mb-4"></h2>
                    <div id="quiz-question" class="text-lg mb-4"></div>
                    <div id="quiz-options" class="space-y-2"></div>
                    <p id="quiz-feedback" class="mt-4 font-bold text-center"></p>
                </div>
            </div>
        </div>

        <div id="knowledge-battle-page" class="p-6 hidden">
            <button onclick="showPage('student-home-page')" class="mb-4 text-blue-600 font-semibold" data-key="back_button">&larr; Back to Home</button>
            <h1 class="text-2xl font-bold text-center mb-4" data-key="mode2_title">Knowledge Battle</h1>
            
            <div id="battle-start-screen">
                <p class="text-center mb-4" data-key="battle_instructions">Get ready for a 3-question speed challenge!</p>
                <button onclick="startBattle()" class="w-full bg-orange-500 text-white p-3 rounded-md font-bold" data-key="start_battle_button">Start Battle</button>
            </div>
            
            <div id="battle-game-screen" class="hidden">
                 <div class="text-center mb-4">
                    <p class="text-sm text-slate-500" data-key="time_remaining">Time Remaining</p>
                    <p id="battle-timer" class="text-3xl font-bold">10</p>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-200 rounded-full mx-auto flex items-center justify-center text-3xl">🧑‍🎓</div>
                        <p class="font-bold" data-key="you">You</p>
                        <p id="player-score" class="text-xl font-bold">0</p>
                    </div>
                    <div class="font-bold text-2xl text-slate-400">VS</div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-200 rounded-full mx-auto flex items-center justify-center text-3xl">🤖</div>
                        <p class="font-bold" data-key="opponent">Opponent</p>
                        <p id="opponent-score" class="text-xl font-bold">0</p>
                    </div>
                </div>

                <div class="bg-slate-100 p-4 rounded-lg">
                    <div id="battle-question" class="text-lg text-center font-semibold mb-4"></div>
                    <div id="battle-options" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div id="battle-result" class="text-center mt-4 text-2xl font-bold"></div>
            </div>
        </div>
        
        <div id="build-lab-page" class="p-6 hidden">
            <button onclick="showPage('student-home-page')" class="mb-4 text-blue-600 font-semibold" data-key="back_button">&larr; Back to Home</button>
            <h1 class="text-2xl font-bold text-center mb-4" data-key="mode3_title">Build Your Own Lab</h1>

            <div class="border p-4 rounded-lg">
                <h2 class="font-bold text-lg mb-2" data-key="lab_circuit_title">Experiment: Simple Circuit</h2>
                <p id="circuit-feedback" class="text-center text-green-600 font-semibold mb-2 h-6"></p>
                
                <div class="bg-slate-200 h-48 rounded-md flex justify-around items-center p-4 relative">
                    <div id="battery-dropzone" class="w-16 h-16 border-2 border-dashed border-slate-400 rounded-md flex items-center justify-center text-slate-400" ondrop="drop(event)" ondragover="allowDrop(event)">Bat</div>
                    <div id="wire-dropzone" class="w-16 h-16 border-2 border-dashed border-slate-400 rounded-md flex items-center justify-center text-slate-400" ondrop="drop(event)" ondragover="allowDrop(event)">Wire</div>
                    <div id="bulb-dropzone" class="w-16 h-16 border-2 border-dashed border-slate-400 rounded-md flex items-center justify-center text-slate-400" ondrop="drop(event)" ondragover="allowDrop(event)">Bulb</div>
                    
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                         <div id="circuit-bulb-visual" class="text-5xl bulb opacity-0 transition-opacity">💡</div>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="font-semibold" data-key="toolbox">Toolbox</h3>
                    <div id="lab-toolbox" class="flex space-x-2 p-2 bg-slate-100 rounded-md mt-1 overflow-x-auto">
                        <div id="battery" draggable="true" ondragstart="drag(event)" class="cursor-grab p-2 bg-yellow-300 rounded text-center flex-shrink-0">🔋<br><span class="text-xs" data-key="battery">Battery</span></div>
                        <div id="wire" draggable="true" ondragstart="drag(event)" class="cursor-grab p-2 bg-gray-300 rounded text-center flex-shrink-0">〰️<br><span class="text-xs" data-key="wire">Wire</span></div>
                        <div id="bulb" draggable="true" ondragstart="drag(event)" class="cursor-grab p-2 bg-blue-300 rounded text-center flex-shrink-0">💡<br><span class="text-xs" data-key="bulb">Bulb</span></div>
                    </div>
                     <button onclick="resetCircuit()" class="mt-2 text-sm text-red-500" data-key="reset_button">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="teacher-dashboard-page" class="p-6 hidden">
            <header class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800" data-key="teacher_dashboard_title">Teacher Dashboard</h1>
                    <p class="text-slate-500" data-key="class_overview">Class Overview</p>
                </div>
                <button onclick="logout()" class="text-sm text-red-500 font-semibold flex-shrink-0" data-key="logout_button">Logout</button>
            </header>

            <div class="mb-6 flex justify-center space-x-2">
                <button onclick="setLanguage('en')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="en">English</button>
                <button onclick="setLanguage('hi')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="hi">हिंदी</button>
                <button onclick="setLanguage('mr')" class="lang-btn px-3 py-1 text-sm rounded-full bg-slate-200" data-lang="mr">मराठी</button>
            </div>
            
            <div class="mb-6">
                <h2 class="font-bold text-lg mb-2" data-key="mode_engagement">Mode Engagement</h2>
                <canvas id="mode-engagement-chart"></canvas>
            </div>
            <div class="mb-6">
                <h2 class="font-bold text-lg mb-2" data-key="quiz_scores">Average Quiz Scores</h2>
                <canvas id="quiz-scores-chart"></canvas>
            </div>
            
            <div class="mb-6">
                 <h2 class="font-bold text-lg mb-2" data-key="leaderboard">Leaderboard</h2>
                 <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3" data-key="rank">Rank</th>
                            <th scope="col" class="px-6 py-3" data-key="student">Student</th>
                            <th scope="col" class="px-6 py-3" data-key="score">Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium">1</td>
                            <td class="px-6 py-4">Priya Sharma</td>
                            <td class="px-6 py-4">1250</td>
                        </tr>
                         <tr class="bg-slate-50 border-b">
                            <td class="px-6 py-4 font-medium">2</td>
                            <td class="px-6 py-4">Rohan Singh</td>
                            <td class="px-6 py-4">1100</td>
                        </tr>
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium">3</td>
                            <td class="px-6 py-4">Aisha Khan</td>
                            <td class="px-6 py-4">980</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div>
                 <h2 class="font-bold text-lg mb-2" data-key="data_export">Data Export</h2>
                 <button onclick="exportData()" class="w-full bg-gray-700 text-white p-3 rounded-md font-bold hover:bg-gray-800" data-key="export_csv_button">Export All Data as CSV</button>
            </div>
        </div>

    </div>

    <script>
    // ===================================================================
    // 0. App State & Translations
    // ===================================================================
    let currentPage = 'login-page';
    let currentLanguage = 'en';
    let studentData = {
        standard: null,
        village: {
            'physics-lab': false,
            'biology-farm': false,
            'chemistry-workshop': false,
        },
        lab: {
            circuitComplete: false,
            components: {
                battery: false,
                wire: false,
                bulb: false,
            }
        }
    };

    const translations = {
        en: {
            app_title: "Game & Learn",
            app_subtitle: "Your Journey into Science & Tech",
            student_login_title: "Student Login",
            teacher_login_title: "Teacher Login",
            placeholder_school_code: "School/Institution Code",
            placeholder_student_id: "Student ID/Username",
            placeholder_email: "Email/Username",
            placeholder_password: "Password",
            login_button: "Login",
            welcome: "Welcome, Student!",
            home_subtitle: "Choose your adventure",
            logout_button: "Logout",
            mode1_title: "STEM Village Simulator",
            mode1_desc: "Build a village by mastering STEM concepts.",
            mode2_title: "Knowledge Battle (ज्ञान युद्ध)",
            mode2_desc: "Challenge an opponent in a fast-paced quiz.",
            mode3_title: "Build Your Own Lab (आपली प्रयोगशाळा)",
            mode3_desc: "Conduct virtual experiments hands-on.",
            back_button: "← Back to Home",
            village_instructions: "Click a grayed-out building to start a quiz and unlock it!",
            physics_lab: "Physics Lab",
            biology_farm: "Biology Farm",
            chemistry_workshop: "Chemistry Workshop",
            battle_instructions: "Get ready for a 3-question speed challenge!",
            start_battle_button: "Start Battle",
            time_remaining: "Time Remaining",
            you: "You",
            opponent: "Opponent",
            lab_circuit_title: "Experiment: Simple Circuit",
            toolbox: "Toolbox",
            battery: "Battery",
            wire: "Wire",
            bulb: "Bulb",
            reset_button: "Reset",
            teacher_dashboard_title: "Teacher Dashboard",
            class_overview: "Class Overview",
            mode_engagement: "Mode Engagement",
            quiz_scores: "Average Quiz Scores",
            leaderboard: "Leaderboard",
            rank: "Rank",
            student: "Student",
            score: "Score",
            data_export: "Data Export",
            export_csv_button: "Export All Data as CSV",
            standard_6: "Standard 6", standard_7: "Standard 7", standard_8: "Standard 8",
            standard_9: "Standard 9", standard_10: "Standard 10", standard_11: "Standard 11", standard_12: "Standard 12"
        },
        hi: {
            app_title: "खेलो और सीखो",
            app_subtitle: "विज्ञान और तकनीक में आपकी यात्रा",
            student_login_title: "छात्र लॉगिन",
            teacher_login_title: "शिक्षक लॉगिन",
            placeholder_school_code: "स्कूल/संस्थान कोड",
            placeholder_student_id: "छात्र आईडी/उपयोगकर्ता नाम",
            placeholder_email: "ईमेल/उपयोगकर्ता नाम",
            placeholder_password: "पासवर्ड",
            login_button: "लॉगिन करें",
            welcome: "आपका स्वागत है, छात्र!",
            home_subtitle: "अपना साहसिक कार्य चुनें",
            logout_button: "लॉगआउट",
            mode1_title: "स्टेम विलेज सिम्युलेटर",
            mode1_desc: "स्टेम अवधारणाओं में महारत हासिल करके एक गाँव बनाएँ।",
            mode2_title: "ज्ञान युद्ध",
            mode2_desc: "एक तेज़ गति वाली प्रश्नोत्तरी में प्रतिद्वंद्वी को चुनौती दें।",
            mode3_title: "अपनी प्रयोगशाला बनाएँ (आपली प्रयोगशाळा)",
            mode3_desc: "आभासी प्रयोगों का संचालन करें।",
            back_button: "← होम पर वापस",
            village_instructions: "क्विज़ शुरू करने और उसे अनलॉक करने के लिए एक धूसर इमारत पर क्लिक करें!",
            physics_lab: "भौतिकी लैब",
            biology_farm: "जीव विज्ञान फार्म",
            chemistry_workshop: "रसायन कार्यशाला",
            battle_instructions: "3-प्रश्नों की गति चुनौती के लिए तैयार हो जाइए!",
            start_battle_button: "युद्ध शुरू करें",
            time_remaining: "शेष समय",
            you: "आप",
            opponent: "प्रतिद्वंद्वी",
            lab_circuit_title: "प्रयोग: सरल सर्किट",
            toolbox: "टूलबॉक्स",
            battery: "बैटरी",
            wire: "तार",
            bulb: "बल्ब",
            reset_button: "रीसेट",
            teacher_dashboard_title: "शिक्षक डैशबोर्ड",
            class_overview: "कक्षा का अवलोकन",
            mode_engagement: "मोड सहभागिता",
            quiz_scores: "औसत प्रश्नोत्तरी स्कोर",
            leaderboard: "लीडरबोर्ड",
            rank: "रैंक",
            student: "छात्र",
            score: "स्कोर",
            data_export: "डेटा निर्यात",
            export_csv_button: "सभी डेटा को CSV के रूप में निर्यात करें",
            standard_6: "कक्षा 6", standard_7: "कक्षा 7", standard_8: "कक्षा 8",
            standard_9: "कक्षा 9", standard_10: "कक्षा 10", standard_11: "कक्षा 11", standard_12: "कक्षा 12"
        },
        mr: {
            app_title: "खेळा आणि शिका",
            app_subtitle: "तुमचा विज्ञान आणि तंत्रज्ञानाचा प्रवास",
            student_login_title: "विद्यार्थी लॉगिन",
            teacher_login_title: "शिक्षक लॉगिन",
            placeholder_school_code: "शाळा/संस्था कोड",
            placeholder_student_id: "विद्यार्थी आयडी/वापरकर्तानाव",
            placeholder_email: "ईमेल/वापरकर्तानाव",
            placeholder_password: "पासवर्ड",
            login_button: "लॉगिन करा",
            welcome: "स्वागत आहे, विद्यार्थी!",
            home_subtitle: "तुमचे साहस निवडा",
            logout_button: "लॉगआउट",
            mode1_title: "स्टेम व्हिलेज सिम्युलेटर",
            mode1_desc: "STEM संकल्पनांवर प्रभुत्व मिळवून एक गाव तयार करा.",
            mode2_title: "ज्ञान युद्ध",
            mode2_desc: "जलद प्रश्नमंजुषामध्ये प्रतिस्पर्ध्याला आव्हान द्या.",
            mode3_title: "आपली प्रयोगशाळा",
            mode3_desc: "आभासी प्रयोग स्वतः करा.",
            back_button: "← होमवर परत जा",
            village_instructions: "क्विझ सुरू करण्यासाठी आणि ते अनलॉक करण्यासाठी राखाडी इमारतीवर क्लिक करा!",
            physics_lab: "भौतिकशास्त्र लॅब",
            biology_farm: "जीवशास्त्र फार्म",
            chemistry_workshop: "रसायनशास्त्र कार्यशाळा",
            battle_instructions: "3-प्रश्नांच्या वेगवान आव्हानासाठी सज्ज व्हा!",
            start_battle_button: "युद्ध सुरू करा",
            time_remaining: "उरलेला वेळ",
            you: "तुम्ही",
            opponent: "प्रतिस्पर्धी",
            lab_circuit_title: "प्रयोग: साधे सर्किट",
            toolbox: "टूलबॉक्स",
            battery: "बॅटरी",
            wire: "तार",
            bulb: "बल्ब",
            reset_button: "रीसेट करा",
            teacher_dashboard_title: "शिक्षक डॅशबोर्ड",
            class_overview: "वर्गाचा आढावा",
            mode_engagement: "मोड प्रतिबद्धता",
            quiz_scores: "सरासरी क्विझ गुण",
            leaderboard: "लीडरबोर्ड",
            rank: "रँक",
            student: "विद्यार्थी",
            score: "गुण",
            data_export: "डेटा निर्यात",
            export_csv_button: "सर्व डेटा CSV म्हणून निर्यात करा",
            standard_6: "इयत्ता ६ वी", standard_7: "इयत्ता ७ वी", standard_8: "इयत्ता ८ वी",
            standard_9: "इयत्ता ९ वी", standard_10: "इयत्ता १० वी", standard_11: "इयत्ता ११ वी", standard_12: "इयत्ता १२ वी"
        }
    };

    // ===================================================================
    // 1. Core App Functions (Navigation, Language)
    // ===================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Set default language on load
        setLanguage(currentLanguage);

        // Attach form listeners
        document.getElementById('student-login-form').addEventListener('submit', handleStudentLogin);
        document.getElementById('teacher-login-form').addEventListener('submit', handleTeacherLogin);
    });

    function showPage(pageId) {
        document.getElementById(currentPage).classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');
        currentPage = pageId;
        window.scrollTo(0, 0); // Scroll to top on page change
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        const elements = document.querySelectorAll('[data-key]');
        elements.forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang][key]) {
                el.innerText = translations[lang][key];
            }
        });

        const placeholders = document.querySelectorAll('[data-key-placeholder]');
        placeholders.forEach(el => {
            const key = el.getAttribute('data-key-placeholder');
            if (translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });
        
        // Highlight active language button
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-slate-200');
            if (btn.getAttribute('data-lang') === lang) {
                btn.classList.add('bg-blue-500', 'text-white');
                btn.classList.remove('bg-slate-200');
            }
        });
    }

    function logout() {
        // Reset any student data if necessary
        showPage('login-page');
    }

    // ===================================================================
    // 2. Authentication Logic (MODIFIED)
    // ===================================================================

    function handleStudentLogin(event) {
        event.preventDefault();
        const schoolCode = document.getElementById('school-code').value;
        const studentId = document.getElementById('student-id').value;
        const password = document.getElementById('student-password').value;
        const errorEl = document.getElementById('login-error');

        // Simple validation for prototype: just check if fields are filled
        if (schoolCode && studentId && password) {
            studentData.standard = document.getElementById('student-standard').value;
            errorEl.classList.add('hidden');
            setLanguage(currentLanguage); // Ensure language is set on the new page
            showPage('student-home-page');
        } else {
            errorEl.innerText = "Please fill all fields.";
            errorEl.classList.remove('hidden');
        }
    }

    function handleTeacherLogin(event) {
        event.preventDefault();
        const email = document.getElementById('teacher-email').value;
        const password = document.getElementById('teacher-password').value;
        const errorEl = document.getElementById('login-error');

        // MODIFIED: Simple validation for prototype: just check if fields are filled
        if (email && password) {
            errorEl.classList.add('hidden');
            setLanguage(currentLanguage); // Ensure language is set on the new page
            renderTeacherDashboard(); // Render charts when logging in
            showPage('teacher-dashboard-page');
        } else {
            errorEl.innerText = "Please fill all fields.";
            errorEl.classList.remove('hidden');
        }
    }

    // ===================================================================
    // 3. STEM Village Logic
    // ===================================================================

    const quizzes = {
        physics: [
            { q: "What is the unit of electric current?", o: ["Volt", "Watt", "Ampere", "Ohm"], a: "Ampere" },
            { q: "Which of these is a renewable energy source?", o: ["Coal", "Solar", "Natural Gas", "Petrol"], a: "Solar" }
        ],
        biology: [
            { q: "What is the process by which plants make their food?", o: ["Respiration", "Photosynthesis", "Transpiration", "Germination"], a: "Photosynthesis" },
            { q: "The 'powerhouse' of the cell is the...?", o: ["Nucleus", "Ribosome", "Mitochondrio", "Cell Wall"], a: "Mitochondrion" }
        ],
        chemistry: [
            { q: "What is the chemical symbol for water?", o: ["H2O", "CO2", "O2", "NaCl"], a: "H2O" },
            { q: "Which gas do we breathe out?", o: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"], a: "Carbon Dioxide" }
        ]
    };
    let currentQuizTopic = '';
    let currentQuestionIndex = 0;
    let score = 0;

    function startQuiz(topic) {
        const partId = topic === 'biology' ? 'biology-farm' : (topic === 'chemistry' ? 'chemistry-workshop' : 'physics-lab');
        if (studentData.village[partId]) {
            alert("You have already unlocked this!");
            return;
        }
        
        currentQuizTopic = topic;
        currentQuestionIndex = 0;
        score = 0;
        
        document.getElementById('quiz-modal').classList.remove('hidden');
        document.getElementById('quiz-feedback').innerText = '';
        loadQuizQuestion();
    }

    function loadQuizQuestion() {
        const quizData = quizzes[currentQuizTopic][currentQuestionIndex];
        document.getElementById('quiz-title').innerText = `Question ${currentQuestionIndex + 1} of ${quizzes[currentQuizTopic].length}`;
        document.getElementById('quiz-question').innerText = quizData.q;
        
        const optionsContainer = document.getElementById('quiz-options');
        optionsContainer.innerHTML = '';
        quizData.o.forEach(option => {
            const button = document.createElement('button');
            button.innerText = option;
            button.className = "w-full p-3 text-left border rounded-md hover:bg-slate-100";
            button.onclick = () => selectAnswer(option, quizData.a);
            optionsContainer.appendChild(button);
        });
    }

    function selectAnswer(selected, correct) {
        const feedbackEl = document.getElementById('quiz-feedback');
        feedbackEl.classList.remove('feedback-animation'); // reset animation
        void feedbackEl.offsetWidth; // trigger reflow

        if (selected === correct) {
            score++;
            feedbackEl.innerText = "Correct! ✅";
            feedbackEl.className = "mt-4 font-bold text-center text-green-500 feedback-animation";
        } else {
            feedbackEl.innerText = "Incorrect! ❌";
            feedbackEl.className = "mt-4 font-bold text-center text-red-500 feedback-animation";
        }

        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizzes[currentQuizTopic].length) {
                loadQuizQuestion();
                feedbackEl.innerText = '';
            } else {
                finishQuiz();
            }
        }, 1200);
    }

    function finishQuiz() {
        const modal = document.getElementById('quiz-modal');
        // For this prototype, a score of at least 1 is enough to unlock.
        if (score >= 1) {
            alert(`Quiz complete! You scored ${score}/${quizzes[currentQuizTopic].length}. You earned a blueprint!`);
            let partId = `${currentQuizTopic}-lab`; // Default
            if (currentQuizTopic === 'biology') partId = 'biology-farm';
            if (currentQuizTopic === 'chemistry') partId = 'chemistry-workshop';

            studentData.village[partId] = true;
            document.getElementById(partId).classList.remove('opacity-30');
        } else {
            alert(`Quiz complete. You scored ${score}/${quizzes[currentQuizTopic].length}. Try again to earn the blueprint!`);
        }
        modal.classList.add('hidden');
    }


    // ===================================================================
    // 4. Knowledge Battle Logic
    // ===================================================================
    let battleTimer;
    let battleInterval;
    let battlePlayerScore = 0;
    let battleOpponentScore = 0;
    let battleQuestionNum = 0;

    const battleQuestions = [
        { q: "What planet is known as the Red Planet?", o: ["Earth", "Mars", "Jupiter", "Venus"], a: "Mars" },
        { q: "What is the boiling point of water in Celsius?", o: ["90°C", "100°C", "120°C", "50°C"], a: "100°C" },
        { q: "How many bones are in the adult human body?", o: ["206", "180", "256", "300"], a: "206" }
    ];

    function startBattle() {
        document.getElementById('battle-start-screen').classList.add('hidden');
        document.getElementById('battle-game-screen').classList.remove('hidden');
        battlePlayerScore = 0;
        battleOpponentScore = 0;
        battleQuestionNum = 0;
        document.getElementById('player-score').innerText = 0;
        document.getElementById('opponent-score').innerText = 0;
        document.getElementById('battle-result').innerText = '';
        loadBattleQuestion();
    }

    function loadBattleQuestion() {
        if (battleQuestionNum >= battleQuestions.length) {
            endBattle();
            return;
        }
        
        let timeLeft = 10;
        const timerEl = document.getElementById('battle-timer');
        timerEl.innerText = timeLeft;

        const questionData = battleQuestions[battleQuestionNum];
        document.getElementById('battle-question').innerText = questionData.q;
        const optionsContainer = document.getElementById('battle-options');
        optionsContainer.innerHTML = '';
        
        questionData.o.forEach(option => {
            const button = document.createElement('button');
            button.innerText = option;
            button.className = "w-full p-3 bg-white border rounded-md hover:bg-slate-100";
            button.onclick = () => selectBattleAnswer(option, questionData.a, timeLeft, button);
            optionsContainer.appendChild(button);
        });

        battleInterval = setInterval(() => {
            timeLeft--;
            timerEl.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(battleInterval);
                battleQuestionNum++;
                loadBattleQuestion();
            }
            // Simulate opponent answering
            if (timeLeft === Math.floor(Math.random() * 5) + 2) { // Random time between 2-6 seconds
                battleOpponentScore += 5; // Fixed score for opponent
                document.getElementById('opponent-score').innerText = battleOpponentScore;
            }
        }, 1000);
    }

    function selectBattleAnswer(selected, correct, timeLeft, button) {
        clearInterval(battleInterval);
        document.querySelectorAll('#battle-options button').forEach(b => b.disabled = true);
        
        if (selected === correct) {
            battlePlayerScore += timeLeft; // More points for faster answer
            document.getElementById('player-score').innerText = battlePlayerScore;
            button.classList.add('bg-green-300', 'border-green-500');
        } else {
            button.classList.add('bg-red-300', 'border-red-500');
        }

        setTimeout(() => {
            battleQuestionNum++;
            loadBattleQuestion();
        }, 1000);
    }

    function endBattle() {
        clearInterval(battleInterval);
        document.getElementById('battle-question').innerText = "Battle Over!";
        document.getElementById('battle-options').innerHTML = '';
        const resultEl = document.getElementById('battle-result');
        if (battlePlayerScore > battleOpponentScore) {
            resultEl.innerText = "You Win! 🎉";
            resultEl.className = "text-center mt-4 text-2xl font-bold text-green-500";
        } else if (battleOpponentScore > battlePlayerScore) {
            resultEl.innerText = "You Lose! 😞";
            resultEl.className = "text-center mt-4 text-2xl font-bold text-red-500";
        } else {
            resultEl.innerText = "It's a Draw! 🤝";
            resultEl.className = "text-center mt-4 text-2xl font-bold text-slate-500";
        }
        setTimeout(() => {
            document.getElementById('battle-start-screen').classList.remove('hidden');
            document.getElementById('battle-game-screen').classList.add('hidden');
        }, 3000);
    }

    // ===================================================================
    // 5. Build Your Own Lab Logic
    // ===================================================================
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const draggedEl = document.getElementById(data);
        const dropzoneId = ev.target.id;

        if (dropzoneId.includes(data)) { // e.g. 'battery-dropzone' contains 'battery'
            ev.target.innerHTML = '';
            const clone = draggedEl.cloneNode(true);
            clone.removeAttribute('draggable'); // Prevent dragging from dropzone
            ev.target.appendChild(clone);
            studentData.lab.components[data] = true;
            checkCircuit();
        }
    }

    function checkCircuit() {
        const { battery, wire, bulb } = studentData.lab.components;
        if (battery && wire && bulb) {
            studentData.lab.circuitComplete = true;
            document.getElementById('circuit-bulb-visual').classList.add('on', 'opacity-100');
            document.getElementById('circuit-feedback').innerText = "Circuit Complete! The bulb lights up.";
        }
    }

    function resetCircuit() {
        studentData.lab.circuitComplete = false;
        studentData.lab.components = { battery: false, wire: false, bulb: false };
        
        document.getElementById('battery-dropzone').innerHTML = 'Bat';
        document.getElementById('wire-dropzone').innerHTML = 'Wire';
        document.getElementById('bulb-dropzone').innerHTML = 'Bulb';
        
        document.getElementById('circuit-bulb-visual').classList.remove('on', 'opacity-100');
        document.getElementById('circuit-feedback').innerText = '';
    }


    // ===================================================================
    // 6. Teacher Dashboard Logic
    // ===================================================================
    let modeChart, scoresChart;

    function renderTeacherDashboard() {
        const modeCtx = document.getElementById('mode-engagement-chart').getContext('2d');
        const scoresCtx = document.getElementById('quiz-scores-chart').getContext('2d');

        // Destroy existing charts if they exist to prevent duplicates
        if (modeChart) modeChart.destroy();
        if (scoresChart) scoresChart.destroy();

        modeChart = new Chart(modeCtx, {
            type: 'pie',
            data: {
                labels: ['STEM Village', 'Knowledge Battle', 'Virtual Lab'],
                datasets: [{
                    label: 'Mode Usage',
                    data: [120, 85, 45], // Sample data
                    backgroundColor: ['#3b82f6', '#f97316', '#8b5cf6']
                }]
            },
            options: { responsive: true }
        });

        scoresChart = new Chart(scoresCtx, {
            type: 'bar',
            data: {
                labels: ['Physics', 'Biology', 'Chemistry', 'General'],
                datasets: [{
                    label: 'Average Score (%)',
                    data: [78, 85, 72, 81], // Sample data
                    backgroundColor: '#16a34a'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }

    function exportData() {
        const data = [
            ["student_id", "activity_date", "mode", "score", "time_spent_min"],
            ["S001", "2025-09-18", "STEM Village", "80", "15"],
            ["S002", "2025-09-18", "Knowledge Battle", "120", "10"],
            ["S001", "2025-09-19", "Virtual Lab", "100", "20"],
            ["S003", "2025-09-19", "STEM Village", "90", "25"]
        ];

        let csvContent = "data:text/csv;charset=utf-8," 
            + data.map(e => e.join(",")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "student_data_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    </script>
</body>
</html>